---

- name: Get the current caller identity information
  amazon.aws.aws_caller_info:
  register: aws_info


# see https://docs.ansible.com/ansible/latest/collections/amazon/aws/lambda_module.html
- name: Deploy lambda
  community.aws.lambda:
    name: "{{ aws_lambda }}"
    description: Function to email cost breakout data based on tags/service from Cost Explorer
    region: "{{ region }}"
    s3_bucket: billing-lambda-src
    s3_key: generate_report.py.zip
    runtime: "python3.8"
    role: arn:aws:iam::379068314111:role/service-role/lambda_send_billing_email
    handler: "generate_report.lambda_handler"
    memory_size: 128
    timeout: 5

# TODO way to add layers from Amazon? AWSSDKPandas-Python38

# see https://docs.ansible.com/ansible/latest/collections/community/aws/cloudwatchevent_rule_module.html
- community.aws.cloudwatchevent_rule:
    name: "lambda_{{ aws_lambda }}"
    region: "{{ region }}"
    schedule_expression: "{{ eventbridge_schedule }}"
    description: Run billing report Lambda on schedule
    targets:
      - id: MyTargetId
        arn: arn:aws:lambda:{{ region }}:{{ aws_info.account }}:function:{{ aws_lambda }}
        input: '{"tag-key": "Department", "tag-value": "", "tag-value-default": "MSS", "days": "180", "show-chart": "0", "email-from": "eepps2@illinois.edu", "email-to": "eepps2@illinois.edu"}'

# Example that creates a lambda event notification for a DynamoDB stream
#- name: Add trigger to EventBridge/CloudWatch event
#  community.aws.lambda_event:
#    state: present
#    region: "{{ region }}"
#    event_source: sqs
#    function_name: "{{ aws_lambda }}"
#    source_params:
#      source_arn: "arn:aws:events:{{ region }}:{{ aws_info.account }}:rule/lambda_{{ aws_lambda }}"
#      enabled: True

